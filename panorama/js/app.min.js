var APP=APP||function(){};APP.Main=function(){function e(){console.log("useragent: ",navigator.userAgent),APP.ie=navigator.userAgent.match(/trident/i),APP.isiphone=!!navigator.userAgent.match(/iPhone/i),APP.isWebgAvailable=t(),APP.isCssTransform3dAvailable=!!$("html").hasClass("csstransforms3d"),console.log("isiphone: ",APP.isiphone),console.log("isWebglcompatible: ",APP.isWebgAvailable),console.log("isCssTransform3dAvailable: ",APP.isCssTransform3dAvailable),$("#startbutton .panorama__button__device").text("webgl: "+APP.isWebgAvailable),APP.View.init()}function t(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}}var n;return{getInstance:function(){return n||(n=e()),n}}}(),APP.SkyBox=function(){function e(){console.log("css3d init"),P=u(),t(),n()}function t(){h=$("body"),p=$(document),f=$("#space"),E=document.getElementById("side-back").getContext("2d"),v=document.getElementById("side-left").getContext("2d"),b=document.getElementById("side-front").getContext("2d"),y=document.getElementById("side-right").getContext("2d"),A=document.getElementById("side-top").getContext("2d"),T=document.getElementById("side-bottom").getContext("2d"),w=f.find("[data-rotate]")[0],i()}function n(){h.on({click:function(){console.log($(this).attr("data-url"));var e=$(this);e.attr("data-url")?window.open("http://www.possible.com","_blank"):e.attr("data-action")?APP.View.addYtVideo():($("#loader").show(),m("{{ASSET_PREFIX}}i/content/panorama"),a())}},".hs")}function o(){console.log("skybox: addHotSpots"),$(".side.side-front").append('<span class="hs" data-url="www.hsbc.co.uk" style="left:20%;top:33%"></span>'),$(".side.side-right").append('<span class="hs" data-action="youtube" style="left:50%;top:60%"></span>'),$(".side.side-back").append('<span class="hs" style="left:50%;top:60%"></span>')}function a(){$(".side .hs").remove()}function i(){I=500,$(".side").css({width:I+1,height:I,margin:-I/2+"px"}),$(".side canvas").css({width:I+1,height:I}),$(".side canvas").attr("width",I+1),$(".side canvas").attr("height",I),$(".side-front")[0].style[P]="rotateY(0deg) translateZ(-"+(I/2-1)+"px)",$(".side-left")[0].style[P]="rotateY(90deg) translateZ(-"+(I/2-1)+"px)",$(".side-right")[0].style[P]="rotateY(-90deg) translateZ(-"+(I/2-1)+"px)",$(".side-back")[0].style[P]="rotateY(-180deg) translateZ(-"+(I/2-1)+"px)",$(".side-top")[0].style[P]="rotateY(90deg) rotateX(-90deg) translateZ(-"+(I/2-1)+"px)",$(".side-bottom")[0].style[P]="rotateY(90deg) rotateX(90deg) translateZ(-"+(I/2-1)+"px)"}function r(){}function s(){}function d(){isUserInteracting=!0,h.addClass("c-drag"),H={x:R,y:M}}function c(e){isUserInteracting===!0&&(R=H.x-e.deltaX*x,M=H.y+e.deltaY*x,w.style[P]="rotate3d(1, 0, 0, "+M+"deg) rotate3d(0, 1, 0, "+R+"deg)")}function l(){isUserInteracting=!1,h.removeClass("c-drag")}function m(e){$("#space").show(),console.log("skybox addPanorama: ",e);var t=document.createElement("img");t.onload=function(){E.drawImage(t,0,k,k,C,0,0,I,I),v.drawImage(t,k,k,k,C,0,0,I,I),b.drawImage(t,2*k,k,k,C,0,0,I,I),y.drawImage(t,3*k,k,k,C,0,0,I,I),A.drawImage(t,k,0,k,C,0,0,I,I),T.drawImage(t,k,2*k,k,C,0,0,I,I),$("#loader").hide()},t.src=e+".jpg"}function u(){for(var e=["transform","msTransform","webkitTransform","mozTransform","oTransform"],t=0;t<e.length;t++)if("undefined"!=typeof document.body.style[e[t]])return e[t];return null}function g(){console.log("onResize")}var h,p,f,w,P,E,v,b,y,A,T,x=.2,H=0,R=0,M=0,I=900,S=2e3,C=500,k=S/4;return{init:e,render:r,onTap:s,onPanStart:d,onPanMove:c,onPanEnd:l,onResize:g,addHotSpots:o,addPanorama:m}}(),APP.THREE=function(){function e(){I=$("#panorama"),$("#space").hide();var e=document.createElement("video");e.canPlayType("video/mp4")?y=".mp4":e.canPlayType("video/webm")?y=".webm":alert("cant play video"),s(),h(),window.requestAnimationFrame(n)}function t(){console.log("initBindings threejs"),$(".panorama__inner").mousemove(function(e){var t=void 0===e.offsetX?e.originalEvent.layerX:e.offsetX,n=void 0===e.offsetY?e.originalEvent.layerY:e.offsetY,o=parseInt($(this).width(),10),a=parseInt($(this).height(),10),i=.003;C=(o/2-t)*i,k=(a/2-n)*i}),$("body").on({mouseout:function(){C=0,k=0}},".panorama__inner"),window.DeviceOrientationEvent&&(console.log("window.DeviceOrientationEvent"),window.ondeviceorientation=function(e){var t=e.alpha,n=e.beta,o=e.gamma;C=0,k=0,0==window.orientation?(B=o,V=n-90):90==window.orientation?(B=-t,V=-o-90):-90==window.orientation&&(B=-t,V=o-90)})}function n(){window.requestAnimationFrame(n),T||(B-=C,V+=k)}function o(e){var t=new THREE.Vector3;t.set(e.center.x/window.innerWidth*2-1,2*-(e.center.y/window.innerHeight)+1,.5),t.unproject(w),A.ray.set(w.position,t.sub(w.position).normalize());var n=A.intersectObjects(S);n.length>0&&(n[0].object.material.color.setHex(16777215*Math.random()),"test1"==n[0].object.name?g():"youtube"==n[0].object.name?APP.View.addYtVideo():window.open("http://www.possible.com","_blank"))}function a(e){x&&x.paused&&x.play(),T=!0,_=e.center.x,Y=e.center.y,z=B,j=V}function i(e){T===!0&&(B=e.deltaX*-.1+z,V=.1*e.deltaY+j)}function r(){T=!1}function s(){console.log("initThreejs"),f=new THREE.Scene,w=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1100),w.target=new THREE.Vector3(0,0,0),A=new THREE.Raycaster,l(),P=new THREE.WebGLRenderer,P.setSize(I.width(),I.height()),P.domElement.cssClass="canvas-elem",P.domElement.id="webglcanvas",I.append(P.domElement),w.position.z=5}function d(e){$("#webglcanvas").show(),E=new THREE.SphereGeometry(500,60,40),E.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1)),APP.ie?R=new THREE.ImageUtils.loadTexture(e+"_sphere.jpg",void 0,c):(R&&x&&x.pause(),x=document.createElement("video"),x.width=320,x.height=240,x.autoplay=!1,x.loop=!0,x.src=e+y,console.log(e+y),$("#loader h1").html("Load: "+e),x.setAttribute("crossorigin","anonymous"),$(x).on({waiting:function(){console.log("waiting")},canplaythrough:function(){$("#loader").hide(),x.play()},load:function(){$("#loader").hide(),x.play()}}),x.load(),R=new THREE.Texture(x)),v=new THREE.MeshBasicMaterial({map:R}),b=new THREE.Mesh(E,v),f.add(b),t()}function c(){console.log("texture loaded"),$("#loader").hide()}function l(){var e=new THREE.DirectionalLight(16777215);e.position.set(1,1,1).normalize(),f.add(e);var t=new THREE.AmbientLight(12303291);f.add(t)}function m(){u()}function u(){var e=new THREE.JSONLoader;e.load("i/poco.js",function(e){var t=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("i/poco.png"),colorAmbient:[.480000026226044,.480000026226044,.480000026226044],colorDiffuse:[.480000026226044,.480000026226044,.480000026226044],colorSpecular:[.8999999761581421,.8999999761581421,.8999999761581421]});M=new THREE.Mesh(e,t),M.position.z=15,M.position.x=-25,M.position.y=-10,S.push(M),f.add(M)})}function g(){for(var e=0;e<S.length;e++)f.remove(S[e])}function h(){if(V=Math.max(-85,Math.min(85,V)),W=THREE.Math.degToRad(90-V),L=THREE.Math.degToRad(B),w.target.x=500*Math.sin(W)*Math.cos(L),w.target.y=500*Math.cos(W),w.target.z=500*Math.sin(W)*Math.sin(L),w.lookAt(w.target),H&&H.setPosition(Math.cos(L),Math.cos(W),Math.sin(L)),R&&!APP.ie){if(x.readyState!==x.HAVE_ENOUGH_DATA)return;R.needsUpdate=!0}for(var e=0;e<S.length;e++)S[e].rotation.y+=.01;M&&(M.rotation.y+=.01),P.render(f,w)}function p(){P.setSize(I.width(),I.height())}var f,w,P,E,v,b,y,A,T,x,H,R,M,I,S=[],C=0,k=0,_=0,Y=0,z=0,j=0,B=-180,V=-14,W=0,L=0;return{init:e,render:h,onTap:o,onPanStart:a,onPanMove:i,onPanEnd:r,onResize:p,addHotSpots:m,addPanorama:d}}(),APP.View=function(){function e(){s=$("body"),r=$("#startbutton"),"ie"==$("#panorama").attr("data-render")||APP.isiphone&&APP.isWebgAvailable?(APP.ie=!0,i=APP.THREE,d=!0):"skybox"==$("#panorama").attr("data-render")?(i=APP.SkyBox,d=!0):APP.isWebgAvailable?(i=APP.THREE,d=!0):!APP.isWebgAvailable&&APP.isCssTransform3dAvailable&&(i=APP.SkyBox,d=!0),i&&i.init(),d?(r.show(),$("#loader").hide()):$("#notsupportedbutton").show(),t(),n(),o()}function t(){$(window).resize(function(){i&&i.onResize()}),r.on("click ",function(){r.off(),r.hide(),$("#loader").show(),i.addHotSpots(),i.addPanorama("i/content/panorama")}),s.on({click:function(){$(this).hide()}},".ytvideo")}function n(){hammer=new Hammer(document.body),hammer.get("pan").set({direction:Hammer.DIRECTION_ALL}),hammer.on("tap",function(e){i.onTap(e)}),hammer.on("panstart",function(e){i.onPanStart(e)}),hammer.on("panmove",function(e){i.onPanMove(e)}),hammer.on("panend",function(){i.onPanEnd()})}function o(){window.requestAnimationFrame(o),i&&i.render()}function a(){console.log("addYtVideo");var e=$(".ytvideo"),t=e.find(".ytvideo__inner"),n=$("<iframe>"),o="UU5iAFEp6s8";0==t.find("iframe").length&&(n.attr("src","http://www.youtube.com/embed/"+o+"?autoplay=1&border=0&enablejsapi=1"),t.append(n)),e.show(),n.width(t.width()),n.height(t.height())}var i,r,s,d=!1;return{init:e,addYtVideo:a}}();