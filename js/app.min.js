var APP=APP||function(){};APP.Main=function(){function e(){console.log("useragent: ",navigator.userAgent),APP.ie=navigator.userAgent.match(/trident/i),APP.isiphone=!!navigator.userAgent.match(/iPhone/i),APP.isWebgAvailable=t(),APP.isCssTransform3dAvailable=!!$("html").hasClass("csstransforms3d"),console.log("isiphone: ",APP.isiphone),console.log("isWebglcompatible: ",APP.isWebgAvailable),console.log("isCssTransform3dAvailable: ",APP.isCssTransform3dAvailable),$("#startbutton .panorama__button__device").text("webgl: "+APP.isWebgAvailable+", css3d: "+APP.isCssTransform3dAvailable),APP.View.init()}function t(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}}var n;return{getInstance:function(){return n||(n=e()),n}}}(),APP.SkyBox=function(){function e(){console.log("css3d init"),P=u(),t(),n()}function t(){g=$("body"),h=$(document),f=$("#space"),E=document.getElementById("side-back").getContext("2d"),v=document.getElementById("side-left").getContext("2d"),b=document.getElementById("side-front").getContext("2d"),y=document.getElementById("side-right").getContext("2d"),A=document.getElementById("side-top").getContext("2d"),x=document.getElementById("side-bottom").getContext("2d"),w=f.find("[data-rotate]")[0],i()}function n(){g.on({click:function(){console.log($(this).attr("data-url"));var e=$(this);e.attr("data-url")?window.open("http://www.possible.com","_blank"):e.attr("data-action")?APP.View.addYtVideo():($("#loader").show(),m("{{ASSET_PREFIX}}i/content/panorama"),a())}},".hs")}function o(){console.log("skybox: addHotSpots"),$(".side.side-front").append('<span class="hs" data-url="www.hsbc.co.uk" style="left:20%;top:33%"></span>'),$(".side.side-right").append('<span class="hs" data-action="youtube" style="left:50%;top:60%"></span>'),$(".side.side-back").append('<span class="hs" style="left:50%;top:60%"></span>')}function a(){$(".side .hs").remove()}function i(){I=500,$(".side").css({width:I+1,height:I,margin:-I/2+"px"}),$(".side canvas").css({width:I+1,height:I}),$(".side canvas").attr("width",I+1),$(".side canvas").attr("height",I),$(".side-front")[0].style[P]="rotateY(0deg) translateZ(-"+(I/2-1)+"px)",$(".side-left")[0].style[P]="rotateY(90deg) translateZ(-"+(I/2-1)+"px)",$(".side-right")[0].style[P]="rotateY(-90deg) translateZ(-"+(I/2-1)+"px)",$(".side-back")[0].style[P]="rotateY(-180deg) translateZ(-"+(I/2-1)+"px)",$(".side-top")[0].style[P]="rotateY(90deg) rotateX(-90deg) translateZ(-"+(I/2-1)+"px)",$(".side-bottom")[0].style[P]="rotateY(90deg) rotateX(90deg) translateZ(-"+(I/2-1)+"px)"}function s(){}function r(){}function d(){isUserInteracting=!0,g.addClass("c-drag"),H={x:R,y:M}}function c(e){isUserInteracting===!0&&(R=H.x-e.deltaX*T,M=H.y+e.deltaY*T,w.style[P]="rotate3d(1, 0, 0, "+M+"deg) rotate3d(0, 1, 0, "+R+"deg)")}function l(){isUserInteracting=!1,g.removeClass("c-drag")}function m(e){$("#space").show(),console.log("skybox addPanorama: ",e);var t=document.createElement("img");t.onload=function(){E.drawImage(t,0,S,S,k,0,0,I,I),v.drawImage(t,S,S,S,k,0,0,I,I),b.drawImage(t,2*S,S,S,k,0,0,I,I),y.drawImage(t,3*S,S,S,k,0,0,I,I),A.drawImage(t,S,0,S,k,0,0,I,I),x.drawImage(t,S,2*S,S,k,0,0,I,I),$("#loader").hide()},t.src=e+".jpg"}function u(){for(var e=["transform","msTransform","webkitTransform","mozTransform","oTransform"],t=0;t<e.length;t++)if("undefined"!=typeof document.body.style[e[t]])return e[t];return null}function p(){console.log("onResize")}var g,h,f,w,P,E,v,b,y,A,x,T=.2,H=0,R=0,M=0,I=900,C=2e3,k=500,S=C/4;return{init:e,render:s,onTap:r,onPanStart:d,onPanMove:c,onPanEnd:l,onResize:p,addHotSpots:o,addPanorama:m}}(),APP.THREE=function(){function e(){M=$("#panorama"),$("#space").hide();var e=document.createElement("video");e.canPlayType("video/mp4")?y=".mp4":e.canPlayType("video/webm")?y=".webm":alert("cant play video"),r(),g(),window.requestAnimationFrame(n)}function t(){console.log("initBindings threejs"),$(".panorama__inner").mousemove(function(e){var t=void 0===e.offsetX?e.originalEvent.layerX:e.offsetX,n=void 0===e.offsetY?e.originalEvent.layerY:e.offsetY,o=parseInt($(this).width(),10),a=parseInt($(this).height(),10),i=.003;C=(o/2-t)*i,k=(a/2-n)*i}),$("body").on({mouseout:function(){C=0,k=0}},".panorama__inner"),window.DeviceOrientationEvent&&(console.log("window.DeviceOrientationEvent"),window.ondeviceorientation=function(e){var t=e.alpha,n=e.beta,o=e.gamma;C=0,k=0,0==window.orientation?(B=o,V=n-90):90==window.orientation?(B=-t,V=-o-90):-90==window.orientation&&(B=-t,V=o-90)})}function n(){window.requestAnimationFrame(n),x||(B-=C,V+=k)}function o(e){var t=new THREE.Vector3;t.set(e.center.x/window.innerWidth*2-1,2*-(e.center.y/window.innerHeight)+1,.5),t.unproject(w),A.ray.set(w.position,t.sub(w.position).normalize());var n=A.intersectObjects(I);n.length>0&&(n[0].object.material.color.setHex(16777215*Math.random()),"test1"==n[0].object.name?p():"youtube"==n[0].object.name?APP.View.addYtVideo():window.open("http://www.possible.com","_blank"))}function a(e){T&&T.paused&&T.play(),x=!0,S=e.center.x,_=e.center.y,z=B,Y=V}function i(e){x===!0&&(B=e.deltaX*-.1+z,V=.1*e.deltaY+Y)}function s(){x=!1}function r(){f=new THREE.Scene,w=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1100),w.target=new THREE.Vector3(0,0,0),A=new THREE.Raycaster,l(),P=new THREE.WebGLRenderer,P.setSize(M.width(),M.height()),P.domElement.cssClass="canvas-elem",P.domElement.id="webglcanvas",M.append(P.domElement),w.position.z=5}function d(e){$("#webglcanvas").show(),E=new THREE.SphereGeometry(500,60,40),E.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1)),APP.ie?R=new THREE.ImageUtils.loadTexture(e+"_sphere.jpg",void 0,c):(R&&T&&T.pause(),T=document.createElement("video"),T.width=320,T.height=240,T.autoplay=!1,T.loop=!0,T.src=e+y,console.log(e+y),$("#loader h1").html("Load: "+e),T.setAttribute("crossorigin","anonymous"),$(T).on({waiting:function(){console.log("waiting")},canplaythrough:function(){$("#loader").hide(),T.play()},load:function(){$("#loader").hide(),T.play()}}),T.load(),R=new THREE.Texture(T)),v=new THREE.MeshBasicMaterial({map:R}),b=new THREE.Mesh(E,v),f.add(b),t()}function c(){console.log("texture loaded"),$("#loader").hide()}function l(){var e=new THREE.PointLight(16777215);e.position.x=10,e.position.y=50,e.position.z=130,f.add(e)}function m(){u({color:16711680,position:{x:0,z:-2},name:"test1"}),u({color:65280,position:{x:2},name:"test2"}),u({color:65280,position:{x:6,y:2},name:"youtube"})}function u(e){var t,n=new THREE.MeshLambertMaterial({color:16711680}),o=new THREE.BoxGeometry(1,1,1);t=new THREE.Mesh(o,n),t.name=e.name,t.position.x=e.position.x,t.position.y=e.position.y||0,t.position.z=e.position.z||0,f.add(t),I.push(t)}function p(){for(var e=0;e<I.length;e++)f.remove(I[e])}function g(){if(V=Math.max(-85,Math.min(85,V)),W=THREE.Math.degToRad(90-V),j=THREE.Math.degToRad(B),w.target.x=500*Math.sin(W)*Math.cos(j),w.target.y=500*Math.cos(W),w.target.z=500*Math.sin(W)*Math.sin(j),w.lookAt(w.target),H&&H.setPosition(Math.cos(j),Math.cos(W),Math.sin(j)),R&&!APP.ie){if(T.readyState!==T.HAVE_ENOUGH_DATA)return;R.needsUpdate=!0}P.render(f,w)}function h(){P.setSize(M.width(),M.height())}var f,w,P,E,v,b,y,A,x,T,H,R,M,I=[],C=0,k=0,S=0,_=0,z=0,Y=0,B=-180,V=-14,W=0,j=0;return{init:e,render:g,onTap:o,onPanStart:a,onPanMove:i,onPanEnd:s,onResize:h,addHotSpots:m,addPanorama:d}}(),APP.View=function(){function e(){r=$("body"),s=$("#startbutton"),"ie"==$("#panorama").attr("data-render")||APP.isiphone&&APP.isWebgAvailable?(APP.ie=!0,i=APP.THREE,d=!0):"skybox"==$("#panorama").attr("data-render")?(i=APP.SkyBox,d=!0):APP.isWebgAvailable?(i=APP.THREE,d=!0):!APP.isWebgAvailable&&APP.isCssTransform3dAvailable&&(i=APP.SkyBox,d=!0),i&&i.init(),d?(s.show(),$("#loader").hide()):$("#notsupportedbutton").show(),t(),n(),o()}function t(){$(window).resize(function(){i&&i.onResize()}),s.on("click ",function(){s.off(),s.hide(),$("#loader").show(),i.addHotSpots(),i.addPanorama("i/content/panorama")}),r.on({click:function(){$(this).hide()}},".ytvideo")}function n(){hammer=new Hammer(document.body),hammer.get("pan").set({direction:Hammer.DIRECTION_ALL}),hammer.on("tap",function(e){i.onTap(e)}),hammer.on("panstart",function(e){i.onPanStart(e)}),hammer.on("panmove",function(e){i.onPanMove(e)}),hammer.on("panend",function(){i.onPanEnd()})}function o(){window.requestAnimationFrame(o),i&&i.render()}function a(){console.log("addYtVideo");var e=$(".ytvideo"),t=e.find(".ytvideo__inner"),n=$("<iframe>"),o="UU5iAFEp6s8";0==t.find("iframe").length&&(n.attr("src","http://www.youtube.com/embed/"+o+"?autoplay=1&border=0&enablejsapi=1"),t.append(n)),e.show(),n.width(t.width()),n.height(t.height())}var i,s,r,d=!1;return{init:e,addYtVideo:a}}();